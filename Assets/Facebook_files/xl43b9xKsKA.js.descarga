;/*FB_PKG_DELIM*/

__d("MAWMessageList.react",["BaseTheme.react","CometErrorBoundary.react","CometPageletWithDiv.react","CometScreenReaderText.react","I64","MAWMessageListRow.react","MWBaseTheme","MWBlockingProtectionContext.react","MWContextBanner.react","MWInboxThreadMessagesSpinner.react","MWPMessageListColumn.react","MWPMessageListFocusTable.react","MWPThreadCapabilitiesContext","MWPTypingIndicators.react","MWV2MessageRowSimple.react","ReQL","ReQLSuspense","cr:314","cr:3907","cr:7567","cr:844","gkx","qex","react","useMAWOfflineQueueLoadingIndicator","useMWMessageRowTheme","useMWPAriaLabelForMessageListGrid","useReStore","useThreadLastMessageTimeMs","withCometPlaceholder"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k=j||(j=d("react")),l=j,m=l.useId,n=l.useState;function a(a){var b=a.theme;b=b===void 0?d("MWBaseTheme").empty:b;var e=a.threadKey;a=a.threadType;var f=d("MWPTypingIndicators.react").useTypingParticipants(e),g=d("MWPTypingIndicators.react").useAccessibilityText(f);if(f.length>0)return k.jsx(c("BaseTheme.react"),{config:b,children:k.jsx(c("MWV2MessageRowSimple.react"),{children:k.jsxs(d("MWPMessageListColumn.react").MWPMessageListColumnGrow,{children:[k.jsx("div",{"aria-live":"polite",children:k.jsx(c("CometScreenReaderText.react"),{text:g})}),k.jsx(d("MWPTypingIndicators.react").MWPTypingIndicators,{threadKey:e,threadType:a})]})})});else return null}a.displayName=a.name+" [from "+f.id+"]";var o=d("withCometPlaceholder").withCometPlaceholder(a);l=k.forwardRef(e);function e(a,e){var g=a.cutoverOpenThread,j=a.entryPoint,l=a.onScrollToBottom,p=a.thread,q=(h||(h=c("useReStore")))(),r=c("useThreadLastMessageTimeMs")(p.threadKey);a=(a=d("ReQLSuspense").useFirst(function(){return d("ReQL").fromTableAscending(q.tables.threads,["lastActivityTimestampMs"]).getKeyRange(p.threadKey).map(function(a){a=a.lastActivityTimestampMs;return r!=null?(i||(i=d("I64"))).lt(r,a):!0})},[q,r,p.threadKey],f.id+":129"))!=null?a:!1;var s=c("useMWPAriaLabelForMessageListGrid")(p),t=c("useMWMessageRowTheme")(),u=n(""),v=u[0];u=u[1];var w=m(),x=c("useMAWOfflineQueueLoadingIndicator")(!1,p),y=!x&&a&&!((x=c("qex")._("97"))!=null?x:!1),z=b("cr:844")==null?void 0:b("cr:844")(p.threadKey);a=k.jsx(b("cr:314"),{entryPoint:j,onScrollToBottom:l,pageSize:c("gkx")("23432")?3:15,ref:e,renderFooter:function(){return k.jsxs(k.Fragment,{children:[k.jsx(o,{theme:t,threadKey:p.threadKey,threadType:p.threadType}),y&&b("cr:7567")?k.jsx(c("CometErrorBoundary.react"),{fallback:function(){return null},children:k.jsx(b("cr:7567"),{})}):null]})},renderHeader:function(){return k.jsxs(d("MWPMessageListColumn.react").MWPMessageListColumnGrowJustified,{children:[k.jsx(d("MWPMessageListColumn.react").MWPMessageListColumnVerticalRhythm,{height:20}),k.jsx(c("MWContextBanner.react"),{threadKey:p.threadKey,threadType:p.threadType}),k.jsx(d("MWPMessageListColumn.react").MWPMessageListColumnVerticalRhythm,{height:10})]})},renderLoadingAnimation:function(){return k.jsx(c("MWInboxThreadMessagesSpinner.react"),{})},renderRow:function(a){var b=a.domElementRef,d=a.message,e=a.nextMessage;a=a.prevMessage;return k.jsx(c("MAWMessageListRow.react"),{domElementRef:b,lastEbMessageTime:z,modal:v,row:{message:d,nextMessage:e,prevMessage:a},thread:p})},secondaryThread:g,thread:p});return k.jsx("div",{className:"x78zum5 xdt5ytf x1iyjqo2 x5yr21d","data-testid":void 0,id:w,children:k.jsx(d("CometPageletWithDiv.react").Placeholder,{className:"x78zum5 xdt5ytf x1iyjqo2 x5yr21d",fallback:null,name:"MWV2MessageList",children:k.jsx(d("MWPThreadCapabilitiesContext").Provider,{thread:p,children:k.jsx(c("MWBlockingProtectionContext.react").Provider,{children:k.jsx(c("MWPMessageListFocusTable.react"),{ariaLabel:s,modal:v,setModal:u,children:b("cr:3907")==null?a:k.jsx(b("cr:3907"),{id:w,children:a})})})})})})}e.displayName=e.name+" [from "+f.id+"]";a=l;g["default"]=a}),98);
__d("MAWSecureThreadDetail.react",["CometPlaceholder.react","ComponentMountUnmountSubspanLogger.react","E2EEMessagingLinkContext.react","I64","LSAuthorityLevel","LSIntEnum","MAWMessageList.react","cr:9776","react","useReStore","useSecureThreadDetailGetDevices"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k,l=k||(k=d("react")),m=k.useState;function a(a){var e=a.cutoverOpenThread,f=a.entryPoint,g=a.messageListRef;a=a.thread;var k=(h||(h=c("useReStore")))();c("useSecureThreadDetailGetDevices")(a,k);k=m(!0);var n=k[0],o=k[1];k=e!=null&&(i||(i=d("I64"))).equal(e.authorityLevel,(j||(j=d("LSIntEnum"))).ofNumber(c("LSAuthorityLevel").AUTHORITATIVE));return l.jsxs(l.Fragment,{children:[l.jsx(c("CometPlaceholder.react"),{fallback:null,name:"MAWCutoverEncryptedBackupsBanner",children:b("cr:9776")!=null&&k&&l.jsx(b("cr:9776"),{isShown:!n})}),l.jsxs(d("E2EEMessagingLinkContext.react").E2EEMessagingLinkProvider,{isSecure:!0,children:[l.jsx(c("ComponentMountUnmountSubspanLogger.react"),{description:"MAWSecureThreadDetail"}),l.jsx(c("MAWMessageList.react"),{cutoverOpenThread:e,entryPoint:f,onScrollToBottom:function(a){return o(a)},ref:g,thread:a})]})]})}a.displayName=a.name+" [from "+f.id+"]";g["default"]=a}),98);
__d("MAWPutMessagesToDB",["MAWBridgeDeleteReactionHandler","MAWBridgeMsgsStartCountdownHandler","MAWBridgeNewMediaHandler","MAWBridgeNewMsgHandler","MAWBridgeNewXMAHandler","MAWBridgeReactionUpsertHandler","Promise","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(a,b,c){return j.apply(this,arguments)}function j(){j=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,c,e){var f=e.expiringCountdown,g=e.medias,i=e.msgs,j=e.reactions;e=e.xmas;yield d("MAWBridgeNewMsgHandler").bulkCall(a,c,i);yield (h||(h=b("Promise"))).all(g.map(function(a){return d("MAWBridgeNewMediaHandler").call(c,a)}));yield h.all(e.map(function(a){return d("MAWBridgeNewXMAHandler").call(c,a)}));yield d("MAWBridgeMsgsStartCountdownHandler").call(c,{msgs:f});yield h.all(j.map(function(a){return a.type==="delete"?d("MAWBridgeDeleteReactionHandler").call(c,a.reaction):d("MAWBridgeReactionUpsertHandler").call(c,a.reaction)}))});return j.apply(this,arguments)}function a(a,b){return a.runInTransaction(function(c){return i(a,c,b)},"readwrite","ui")}g.insertMessageResponseToDBInExistingTransaction=i;g.insertMessageResponseIntoDatabase=a}),98);
__d("MAWSecureLocalDBFetch",["I64","MAWBridgeSendAndReceive","MAWDbMsg","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";var h;function a(a){return i.apply(this,arguments)}function i(){i=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b=a.chatJid,c=a.config,e=a.count,f=a.direction,g=a.offsetMsg;a=a.timestampMs;return babelHelpers["extends"]({},yield d("MAWBridgeSendAndReceive").sendAndReceive("backend","maw_load_msgs",{chatJid:b,config:c,direction:f,includeOriginalMsg:(b=g==null?void 0:g.includeOriginalMsg)!=null?b:!1,msgId:(g==null?void 0:g.messageId)==null?null:d("MAWDbMsg").toMsgId(g.messageId),numMsgs:e,sortOrderMs:a!=null?(h||(h=d("I64"))).to_float(a):null}))});return i.apply(this,arguments)}g["default"]=a}),98);
__d("MAWSecureLocalDBDataSource",["I64","LSEncryptedBackupsBackupTenancy","LSIntEnum","MAWBridgeSendAndReceive","MAWDataSourceLogger","MAWDbMsg","MAWEncryptedBackupUtils","MAWMiActOnActThreadReady","MAWPutMessagesToDB","MAWSecureDataSource","MAWSecureLocalDBFetch","WATagsLogger","asyncToGeneratorRuntime","gkx","requireDeferred"],(function(a,b,c,d,e,f,g){"use strict";var h,i;function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["Failed to fetch messages: ",""]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["useFetchSecureMessages: threadJid: "," threadId: "," minMsgSortOrderTsResponse ",""]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["Transaction is done"]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["Transaction"]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["Issue comet task"]);n=function(){return a};return a}function o(){var a=babelHelpers.taggedTemplateLiteralLoose(["Fetch more: ",""]);o=function(){return a};return a}var p=c("requireDeferred")("MAWEBFetch").__setRef("MAWSecureLocalDBDataSource"),q=d("WATagsLogger").TAGS(["MAWSecureLocalDBDataSource"]);a=function(){function a(){this.$1=new Map(),this.$2=20}var e=a.prototype;e.$3=function(a,b,c,e){this.$1.set(b+"_"+(a!=null?(h||(h=d("I64"))).to_string(a):"null")+"_"+c,{hasMoreAfter:e.hasMoreAfter,hasMoreBefore:e.hasMoreBefore,msgs:e.msgs.map(function(a){return{externalId:a.externalId,sortOrderMs:a.sortOrderMs}})});if(this.$1.size>this.$2){b=this.$1.keys().next();b.done||this.$1["delete"](b.value)}};e.$4=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,e,f,g,j,r,s){if(j==="after")return;j;q.LOG(o(),e);d("MAWDataSourceLogger").logLoadMoreMsgsThreadWaiting(s,"before",e);j=(yield d("MAWMiActOnActThreadReady").waitForACTThreadReady(a.tables,e,"MAWFetchMoreMessages"));e=j.chatId;j=j.chatJid;d("MAWDataSourceLogger").logLoadMoreMsgsThreadReadyFetchMsgs(s);q.LOG(n());var t=(yield c("MAWSecureLocalDBFetch")({chatJid:j,config:{media:!0,reactions:!0,xma:!0},count:r,direction:"before",offsetMsg:{includeOriginalMsg:!1,messageId:g.minMessageId},timestampMs:f}));this.$3(f,g.minMessageId,"before",t);q.LOG(m());var u=t.msgs.length>0?t.msgs[t.msgs.length-1].msgId:g.minMessageId;yield a.runInTransaction(function(){var e=b("asyncToGeneratorRuntime").asyncToGenerator(function*(b){var e;yield d("MAWPutMessagesToDB").insertMessageResponseToDBInExistingTransaction(a,b,t);e=(yield (e=b.messages_ranges_v2__generated).get.apply(e,[g.threadKey,g.minTimestampMs,g.minMessageId]));if(e==null)return;var f=t.hasMoreBefore;if(t.hasMoreBefore===!1&&c("gkx")("23914")){var j=(yield d("MAWEncryptedBackupUtils").getBackupTenancy(a.tables));j!=null&&(h||(h=d("I64"))).equal(j,(i||(i=d("LSIntEnum"))).ofNumber(c("LSEncryptedBackupsBackupTenancy").PRODUCTION))&&(f=!0)}yield b.messages_ranges_v2__generated.upsert([e.threadKey,e.minTimestampMs,e.minMessageId],{hasMoreAfter:!1,hasMoreBefore:f,isLoadingAfter:!1,isLoadingBefore:!1,maxMessageId:e.maxMessageId,maxTimestampMs:e.maxTimestampMs,minMessageId:u,minTimestampMs:(h||(h=d("I64"))).zero,threadKey:g.threadKey})});return function(a){return e.apply(this,arguments)}}(),"readwrite","ui");q.LOG(l());d("MAWDataSourceLogger").logLoadMoreMsgsFetched(s,t.hasMoreBefore);if(t.hasMoreBefore){d("MAWDataSourceLogger").logLoadMoreMsgsSuccess(s);return}f=(yield d("MAWBridgeSendAndReceive").sendAndReceive("backend","getMaybeNextNonAdminMsgSortOrderMs",{mayBeAdminMsgId:d("MAWDbMsg").toMsgId(g.minMessageId),threadId:e}));d("WATagsLogger").TAGS(["labyrinth_web","useFetchSecureMessages"]).LOG(k(),j,e,f.minMsgTimestampMs);d("MAWDataSourceLogger").logLoadMoreMsgsRangeQuery(s,f.minMsgTimestampMs);j=(yield p.load());yield j({chatId:e,count:r,db:a,direction:"before",timestampMs:(h||(h=d("I64"))).of_float(f.minMsgTimestampMs)});d("MAWDataSourceLogger").logLoadMoreMsgsSuccess(s)});function e(b,c,d,e,f,g,h){return a.apply(this,arguments)}return e}();e.requestMessages=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,e,f,g,i,j,k){b=(a=g)!=null?a:"no_message_id";a=c("gkx")("1310");if(!a&&f!=null){var l=this.$1.get(b+"_"+(h||(h=d("I64"))).to_string(f)+"_"+i);if(l!=null)return l}e=(yield c("MAWSecureLocalDBFetch")({chatJid:e,config:k,count:(l=j)!=null?l:d("MAWSecureDataSource").DEFAULT_NUM_MESSAGES,direction:"before",offsetMsg:g==null?null:{includeOriginalMsg:!1,messageId:g},timestampMs:f}));k=e.msgs.map(function(a){return{externalId:a.externalId,sortOrderMs:a.sortOrderMs}});a||this.$3(f,b,i,e);return{hasMoreAfter:e.hasMoreAfter,hasMoreBefore:e.hasMoreBefore,msgs:k}});function e(b,c,d,e,f,g,h,i){return a.apply(this,arguments)}return e}();e.fetchSecureMessagesProtocol=function(a,b,c,e,f,g){g===void 0&&(g=d("MAWSecureDataSource").DEFAULT_NUM_MESSAGES);var h=d("MAWDataSourceLogger").logLoadMoreMsgsStart();return this.$4(a,b,c,e,f,g,h)["catch"](function(a){q.ERROR(j(),a),d("MAWDataSourceLogger").logLoadMoreMsgsRuntimeError(h,a)})};return a}();g["default"]=a}),98);
__d("MAWMessageIntegrityCheckDeferred",["requireDeferred"],(function(a,b,c,d,e,f,g){"use strict";var h=c("requireDeferred")("MAWMessageIntegrityCheck").__setRef("MAWMessageIntegrityCheckDeferred");function a(a,b,c,d,e,g,i){h.onReady(function(h){return h.runMessageIntegrityCheck(a,b,c,d,e,g,i)})}g.runMessageIntegrityCheckDeferred=a}),98);
__d("useCheckMessageIntegrityForSecureThread",["Int64Hooks","MAWMessageIntegrityCheckDeferred","MetaConfig","Random","useMWEntrypoint"],(function(a,b,c,d,e,f,g){"use strict";var h=c("MetaConfig")._("59");function a(a,b,e,f){var g=c("useMWEntrypoint")();return d("Int64Hooks").useCallbackInt64(function(c,i){if(!d("Random").coinflip(h))return;d("MAWMessageIntegrityCheckDeferred").runMessageIntegrityCheckDeferred(a,b,e,g,f,c,i)},[a,b,e,g,f])}g["default"]=a}),98);